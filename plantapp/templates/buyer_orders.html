{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders</title>

    <!-- Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        body {
            background-color: #f8f9fa;
        }
        .order-card {
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease-in-out;
        }
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .card-body p {
            margin-bottom: 5px;
            font-size: 14px;
        }
        .action-buttons button, .action-buttons a {
            width: 100%;
            margin-top: 5px;
        }
        .return-form {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container mt-3">

    <!-- Navigation Buttons at the Top -->
    <div class="d-flex justify-content-between mb-3">
        <a href="{% url 'buyerhome' %}" class="fs-4">
            <i class="fas fa-home"></i>
        </a>
        
        <h2 class="text-center flex-grow-1">My Orders</h2>
        <div class="text-center d-inline-block me-3">
            <a href="{% url 'buyer_return_orders' %}" class="text-dark text-decoration-none">
                <i class="fas fa-undo-alt fa-lg"></i>
                <div>Return</div>
            </a>
        </div>
        
        <div class="text-center d-inline-block">
            <a href="{% url 'buyer_order_view' %}" class="text-dark text-decoration-none">
                <i class="fas fa-exchange-alt fa-lg"></i>
                <div>Replace</div>
            </a>
        </div>
        
   
           
    </div>

    {% if buyer_orders %}
        <div class="row">
            {% for order in buyer_orders %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card order-card shadow-lg">
                        <div class="card-body">
                            <h5 class="card-title text-primary">{{ order.plant.plant_name }}</h5>
                            <p><strong>Order ID:</strong> {{ order.order_id }}</p>
                            <p><strong>Company:</strong> {{ order.seller.company_name }}</p>
                            <p><strong>Total Amount:</strong> <span class="text-success">${{ order.total_amount }}</span></p>
                            <p><strong>Order Date:</strong> {{ order.order_date }}</p>
                            <p><strong>Payment Status:</strong> <span class="badge bg-info">{{ order.payment.payment_status }}</span></p>
                            <p><strong>Payment Method:</strong> {{ order.payment.payment_method }}</p>
                            <p><strong>Status:</strong> <span class="badge bg-warning">{{ order.status }}</span></p>
                            <p><strong>Quantity:</strong> {{ order.quantity }}</p>

                            <!-- Selection Dropdown -->
                            {% if order.status == "Delivered" and order.payment.payment_method != "Cash on Delivery" %}
                                <select id="select-action-{{ order.id }}" class="form-select mt-2" onchange="showActionButton('{{ order.id }}')">
                                    <option value="">Select Action</option>
                                    <option value="return">Return & Refund</option>
                                    <option value="replace">Request Replacement</option>
                                </select>

                                <!-- Action Buttons -->
                                <div class="action-buttons text-center mt-3">
                                    <button id="return-btn-{{ order.id }}" class="btn btn-warning btn-sm" style="display:none;" onclick="handleActionClick('{{ order.id }}', 'return')">
                                        <i class="fas fa-undo"></i> Return & Refund
                                    </button>
                                    <a id="replace-btn-{{ order.id }}" href="{% url 'replace_product' order.id %}" class="btn btn-info btn-sm" style="display:none;">
                                        Request Replacement
                                    </a>
                                </div>

                                <!-- Hidden Return Form -->
                                <form id="return-form-{{ order.id }}" action="{% url 'request_return' order.id %}" method="post" class="return-form" onsubmit="disableSelection('{{ order.id }}')">
                                    {% csrf_token %}
                                    <textarea name="return_reason" class="form-control mt-2" placeholder="Enter reason for return..." required></textarea>
                                    <button type="submit" class="btn btn-danger btn-sm mt-2">Submit Return</button>
                                </form>
                            {% else %}
                                <span class="text-muted">Not Eligible</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-center text-muted">You have no orders at the moment.</p>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let orders = document.querySelectorAll("[id^='select-action-']");
    
        orders.forEach(order => {
            let orderId = order.id.split("-").pop();
            let status = localStorage.getItem("order-" + orderId);
    
            if (status) {
                disableSelection(orderId);
            }
        });
    });
    
    function showActionButton(orderId) {
        let action = document.getElementById("select-action-" + orderId).value;
    
        if (localStorage.getItem("order-" + orderId)) {
            alert("You have already requested a return or replacement for this order.");
            document.getElementById("select-action-" + orderId).value = ""; 
            return;
        }
    
        document.getElementById("return-btn-" + orderId).style.display = action === "return" ? "block" : "none";
        document.getElementById("replace-btn-" + orderId).style.display = action === "replace" ? "block" : "none";
    }
    
    function handleActionClick(orderId, action) {
        if (action === "return") {
            document.getElementById("return-form-" + orderId).style.display = "block";
        }
    }
    
    function disableSelection(orderId) {
        document.getElementById("select-action-" + orderId).disabled = true;
        let returnBtn = document.getElementById("return-btn-" + orderId);
        let replaceBtn = document.getElementById("replace-btn-" + orderId);
    
        if (returnBtn) returnBtn.disabled = true;
        if (replaceBtn) replaceBtn.disabled = true;
    }
    
    // Handle return form submission
    document.querySelectorAll("[id^='return-form-']").forEach(form => {
        form.addEventListener("submit", function (event) {
            let orderId = this.id.split("-").pop();
            localStorage.setItem("order-" + orderId, "processed");
            disableSelection(orderId);
            alert("Your return request has been submitted successfully.");
        });
    });
    
    // Handle replacement request
    document.querySelectorAll("[id^='replace-btn-']").forEach(button => {
        button.addEventListener("click", function (event) {
            event.preventDefault(); // Prevent immediate redirection
            let orderId = this.id.split("-").pop();
    
            if (!localStorage.getItem("order-" + orderId)) {
                localStorage.setItem("order-" + orderId, "processed");
                disableSelection(orderId);
                alert("Do you Want to replace the prodcut ?.");
    
                // Redirect after alert
                window.location.href = this.href;
            } else {
                alert("Your return request is submitted successfully.");
            }
        });
    });
    
</script>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

